# External Callouts

## HTTP

---

Example of a callout to an external web service with a GET method request:

    Http http = new Http();
    HttpRequest request = new HttpRequest();
    request.setEndpoint('https://th-apex-http-callout.herokuapp.com/animals');
    request.setMethod('GET');
    HttpResponse response = http.send(request);

    // If the request is successful, parse the JSON response.
    if (response.getStatusCode() == 200) {

        // Deserialize the JSON string into collections of primitive data types.
        Map<String, Object> results = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());

        // Cast the values in the 'animals' key as a list
        List<Object> animals = (List<Object>) results.get('animals');
        System.debug('Received the following animals:');
        for (Object animal: animals) {
            System.debug(animal);
        }
    }

Setup steps to include HTTP callout in Apex:

1. Instantiate blank new Http object  
    > `Http http = new Http();`
2. Instantiate blank new HttpRequest obejct  
    > `HttpRequest request = new HttpRequest();`
3. Use dot notation to set setEndpoint & setMethod properties to the request object you just created  
    > `request.setEndpoint('URL');`  
    > `request.setMethod('http_method');`
4. Use request object to create new HttpResponse object
    > `HttpResponse response = http.send(request);`
5. If the request returns a successful response, do some processing (probably parsing out JSON response, among other stuff)
    > `if (response.getStatusCode() == 200) {`  
    >   `… code to execute …`  
    > `}`

    - Some other steps may be included for particular HTTP methods; for example, for a POST request method, might include also the following:
        > `request.setHeader('Content-Type', 'application/json;charset=UTF-8');`  
        > `request.setBody('some_JSON_body');`

`Test.setMock()` method lets runtime know that mock callouts are used in a test method

When creating Apex class from WSDL, methods in autogenerated class call `WebServiceCallout.invoke` which performs callout to external service

- Implement `WebServiceMock` interface to instruct Apex runtime to generate fake response whenever `WebServiceCallout.invoke` is called, specify fake response for testing runtime to send
- Calling `Test.setMock()` in your test method instructs Apex runtime to send fake response
  - First argument is `WebServiceMock.class`
  - Second argument is new instance of `WebServiceMock` interface implementation
    > Ex:
    > `Test.setMock(WebServiceMock.class, new MyWebServiceMockImpl());`

When creating mock implementation to fake callout during testing, implementation of `WebServiceMock` calls `doInvoke` method which returns response you specify for testing

> `doInvoke` method parameters include:
>
> - `Object stub,`
> - `Object request,`
> - `Map<String, Object> response,`
> - `String endpoint,`
> - `String soapAction,`
> - `String requestName,`
> - `String responseNS,`
> - `String responseName,`
> - `String responseType`

To make Apex class method available as REST web service, give class global access modifier & method global static; add appropriate annotations

- Examples:
  - for a class: `@RestResource(urlMapping = '/[object]/*')`
  - for a method: `@Http[Get]/[Post]/[Put]/[Delete]`
    > URL mapping is case-sensitive, can contain wildcard character
- Base endpoint for Apex REST is **https:// \[yourinstance\] .salesforce.com/services/apexrest/**;
- URL mapping appended to base endpoint to yield the REST service endpoint

Available annotations for methods in REST service class

| | |
| --- | --- |
| `@HttpGet` | Reads/retrieves records |
| `@HttpPost` | Creates records |
| `@HttpDelete` | Deletes records |
| `@HttpPut` | Used to update existing records or to create records |
| `@HttpPatch` | Used to update fields in existing records|

To make Apex class method available as SOAP web service, give class global access modifier, give method `webservice static` keyword/modifier pair to each method you want to expose

- Some common lines of code in Apex REST class methods:

        RestRequest request = RestContext.request;
        String caseId = request.requestURI.substring(request.requestURI.lastIndexOf('/')+1);

Supported data types for Apex REST as parameters/return values:

- Apex primitives (excluding sObjects & Blob)
- sObjects
- Lists/maps of Apex primitives or sObjects (must have string keys)
- User-defined types containing member variables of above-listed types
